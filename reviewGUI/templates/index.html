<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image & Video Review System</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .media-box {
            width: 100%;
            height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            margin-bottom: 1rem;
            overflow: hidden;
        }
        .media-box img, .media-box video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }
        .comment-input {
            border: 2px solid red;
            background-color: #ffe6e6;
        }
        .comment-input:focus {
            border-color: darkred;
            box-shadow: 0 0 5px rgba(255, 0, 0, 0.7);
        }
    </style>
    <script>
        let images = [];
        let videos = [];
        let currentIndex = 0;
        let currentVideoIndex = 0;

        async function loadMedia() {
            await loadImages();
            await loadVideos();
        }

        async function loadImages() {
            const response = await fetch("/get_images");
            images = await response.json();
            console.log(images)
            if (images.length === 0) {
                document.getElementById("image-container").innerHTML = "<p class='text-center text-muted'>‚úÖ Keine ausstehenden Bilder.</p>";
            } else {
                displayImage(0);
            }
        }

        async function loadVideos() {
            const response = await fetch("/get_videos");
            videos = await response.json();
            console.log(videos)
            if (videos.length === 0) {
                document.getElementById("video-container").innerHTML = "<p class='text-center text-muted'>‚úÖ Keine ausstehenden Videos.</p>";
            } else {
                displayVideo(0);
            }
        }

        function displayImage(index) {
            const container = document.getElementById("image-container");
            container.innerHTML = "";
            if (index >= images.length || index < 0) return;

            const user = images[index];
            console.log(user)

            // Find the pending image in user.images  It will always be the last one
            const pendingImage = user.images[user.images.length - 1]; 

            if (pendingImage && pendingImage.image_status === "pending") {
                console.log("‚úÖ The last image is pending:", pendingImage);
            } else {
                return
            }
            
            const card = document.createElement("div");
            card.className = "card mb-3";
            card.innerHTML = `
                <div class="card-body">
                    <h5 class="card-title">üë§ Bild von ${user.discord_name}</h5>
                    <p class="card-text">
                        <strong>üìá Discord ID:</strong> ${user.discord_id}<br>
                        <strong>üìÖ Eingereicht:</strong> ${pendingImage.timestamp_uploaded}<br>
                        <strong>üìù Epic Name:</strong> ${user.epic_name}<br>
                        <strong>üîó Bild-URL:</strong> <a href="/images/${pendingImage.image_path.split('/').pop()}" target="_blank">Bild URL Link</a>
                    </p>
                    <div class="media-box">
                        <img src="/images/${pendingImage.image_path.split('/').pop()}" alt="User image">
                    </div>
                    <div class="d-flex align-items-center">
                        <button class="btn btn-primary me-2" onclick="approveAllUntilHere()">‚úÖ Alle bis hier genehmigen</button>
                        <input id="comment-${user.discord_id}" type="text" class="form-control comment-input me-2" placeholder="Kommentar f√ºrs Ablehnen eingeben...">
                        <button class="btn btn-danger me-2" onclick="disapproveImage('${user.discord_id}')">‚ùå Ablehnen</button>
                        <button class="btn btn-success" onclick="approveImage('${user.discord_id}')">‚úÖ Genehmigen</button>
                    </div>
                </div>
            `;
            container.appendChild(card);

            document.getElementById("image-progress").innerText = `Bild ${index + 1} von ${images.length}`;
        }

        function displayVideo(index) {
            const container = document.getElementById("video-container");
            container.innerHTML = "";
            if (index >= videos.length || index < 0) return;

            const user = videos[index];
            console.log(user)

            // Find the pending video in user.videos  It will always be the last one
            const pendingVideo = user.videos[user.videos.length - 1]; 

            if (pendingVideo && pendingVideo.video_status === "pending") {
                console.log("‚úÖ The last video is pending:", pendingVideo);
            } else {
                return
            }

            const card = document.createElement("div");
            card.className = "card mb-3";
            card.innerHTML = `
                <div class="card-body">
                    <h5 class="card-title">üé• Video von ${user.discord_name}</h5>
                    <p class="card-text">
                        <strong>üìá Discord ID:</strong> ${user.discord_id}<br>
                        <strong>üìÖ Eingereicht:</strong> ${pendingVideo.timestamp_uploaded}<br>
                        <strong>üìù Epic Name:</strong> ${user.epic_name}<br>
                        <strong>üîó Streamable-Video-URL:</strong> <a href="${pendingVideo.streamable_video_url}" target="_blank" style="font-size: 300%;">Streamable Video URL Link</a>
                    </p>
                    <div class="d-flex align-items-center">
                        <input id="comment-video-${user.discord_id}" type="text" class="form-control comment-input me-2" placeholder="Kommentar f√ºrs Ablehnen eingeben...">
                        <button class="btn btn-danger me-2" onclick="disapproveVideo('${user.discord_id}')">‚ùå Ablehnen</button>
                        <input id="points-${user.discord_id}" type="number" class="form-control me-2" placeholder="Punkte vergeben">
                        <button class="btn btn-success" onclick="approveVideo('${user.discord_id}')">‚úÖ Genehmigen</button>
                    </div>
                </div>
            `;
            container.appendChild(card);

            document.getElementById("video-progress").innerText = `Video ${index + 1} von ${videos.length}`;
        }

        async function approveImage(discord_id) {
            const response = await fetch("/update_image_status", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ discord_id: discord_id, status: "approved" })
            });
            const result = await response.json();
            showTemporaryMessage(result.message, response.ok ? "success" : "danger", "image");

            if (response.ok) {
                images.splice(currentIndex, 1);
                displayImage(currentIndex);
            }
        }

        async function disapproveImage(discord_id) {
            const comment = document.getElementById(`comment-${discord_id}`).value;
            const response = await fetch("/update_image_status", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ discord_id: discord_id, status: "denied", comment: comment })
            });
            const result = await response.json();
            showTemporaryMessage(response.ok ? `‚ùå Bild abgelehnt: ${comment}` : `‚ö†Ô∏è Fehler: ${result.message}`, response.ok ? "success" : "danger", "image");

            if (response.ok) {
                images.splice(currentIndex, 1);
                displayImage(currentIndex);
            }
        }

        async function approveVideo(discord_id) {
            const pointsInput = document.getElementById(`points-${discord_id}`);
            let points = pointsInput.value.trim();

            // If the input is empty, show an alert and stop execution
            if (!points) {
                points = prompt("Bitte gib die Punktezahl ein:", "0");

                // If the user cancels or enters an invalid number, stop execution
                if (points === null || isNaN(points) || points.trim() === "") {
                    alert("‚ùå Die Genehmigung wurde abgebrochen. Bitte gib eine g√ºltige Punktezahl ein.");
                    return;
                }
            }

            points = parseInt(points, 10); // Convert input to integer wit base 10
            const response = await fetch("/update_video_status", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ discord_id: discord_id, status: "approved", points_added: parseInt(points) })
            });
            const result = await response.json();
            showTemporaryMessage(result.message, response.ok ? "success" : "danger", "video");

            if (response.ok) {
                videos.splice(currentVideoIndex, 1);
                displayVideo(currentVideoIndex);
            }
        }

        async function disapproveVideo(discord_id) {
            const comment = document.getElementById(`comment-video-${discord_id}`).value;
            const response = await fetch("/update_video_status", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ discord_id: discord_id, status: "denied", comment: comment })
            });
            const result = await response.json();
            showTemporaryMessage(response.ok ? `‚ùå Video abgelehnt: ${comment}` : `‚ö†Ô∏è Fehler: ${result.message}`, response.ok ? "success" : "danger", "video");

            if (response.ok) {
                videos.splice(currentVideoIndex, 1);
                displayVideo(currentVideoIndex);
            }
        }

        async function approveAllUntilHere() {
            const batch = images.slice(0, currentIndex + 1).map(user => user.discord_id);
            console.log(batch)
            const response = await fetch("/bulk_approve", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ discord_ids: batch })
            });
            const result = await response.json();
            showTemporaryMessage(result.message, response.ok ? "success" : "danger", "image");

            if (response.ok) {
                images = images.slice(currentIndex + 1); // Keep only remaining images
                currentIndex = 0;
                displayImage(0);
            }
        }

        function showTemporaryMessage(message, type, file_type) {
            let container
            if (file_type == "image"){
                container = document.getElementById("message-container");
            } else if (file_type === "video") {
                container = document.getElementById("message-container2");
            }
            if (!container) { // If container is null, log an error
                console.error(`Container not found for file type: ${file_type}`);
                return; // Exit function to avoid further errors
            }
            const alert = document.createElement("div");
            alert.className = `alert alert-${type}`; // test danger here
            alert.innerText = message;
            container.appendChild(alert);

            setTimeout(() => container.removeChild(alert), 3000);
        }

        function handleKeyPress(event) {
            const activeElement = document.activeElement;
            // Avoid shortcuts when typing in the comment input field
            if (activeElement.tagName === "INPUT" && activeElement.type === "text") {
                return;
            }
            if (event.key.toLowerCase() === "a") {
                currentIndex = Math.max(currentIndex - 1, 0);
                displayImage(currentIndex);
            } else if (event.key.toLowerCase() === "d") {
                currentIndex = Math.min(currentIndex + 1, images.length - 1);
                displayImage(currentIndex);
            }
        }

        window.onload = () => {
            loadMedia();
            document.addEventListener("keydown", handleKeyPress);
        };
    </script>
</head>
<body class="container mt-4">
    <h1 class="text-center">üì∑ Bild & Video √úberpr√ºfung</h1>
    <p id="image-progress" class="text-center text-muted"></p>
    <div id="image-container"></div>
    <div id="message-container"></div>
    <p id="video-progress" class="text-center text-muted"></p>
    <div id="video-container"></div>
    <div id="message-container2"></div>
</body>
</html>
